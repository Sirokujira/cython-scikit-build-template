# 'sudo' is enabled automatically by the 'apt' addon below.
#sudo: false 
#sudo: required

language: python            # this works for Linux but is an error on macOS or Windows

# https://docs.travis-ci.com/user/languages/python/#running-python-tests-on-multiple-operating-systems
# https://docs.travis-ci.com/user/reference/xenial#python-support
# https://scikit-build.readthedocs.io/en/latest/installation.html
matrix:
  include:
  - name: Python 2.7 on Xenial
    dist: xenial
    python: '2.7'
    compiler: gcc
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - openni2-utils
        - build-essential
    env:
    - PCL_VERSION="1.7"
    - OS_VERSION="xenial"
    - NOSEATTR="not pcl_ver_0_4 and not pcl_over_18"
    - MATRIX_EVAL="CC=gcc && CXX=g++"
  - name: Python 3.5 on Xenial
    dist: xenial
    python: '3.5'
    compiler: gcc
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - openni2-utils
        - build-essential
    env:
    - PCL_VERSION="1.7"
    - OS_VERSION="xenial"
    - NOSEATTR="not pcl_ver_0_4 and not pcl_over_18"
    - MATRIX_EVAL="CC=gcc && CXX=g++"
  - name: Python 3.6 on Xenial
    dist: xenial
    python: '3.6'
    compiler: gcc
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - openni2-utils
        - build-essential
    env:
    - PCL_VERSION="1.7"
    - OS_VERSION="xenial"
    - NOSEATTR="not pcl_ver_0_4 and not pcl_over_18"
    - MATRIX_EVAL="CC=gcc && CXX=g++"
  - name: Python 3.7 on Xenial
    dist: xenial
    python: '3.7'
    compiler: gcc
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - openni2-utils
        - build-essential
    env:
    - PCL_VERSION="1.7"
    - OS_VERSION="xenial"
    - NOSEATTR="not pcl_ver_0_4 and not pcl_over_18"
    - MATRIX_EVAL="CC=gcc && CXX=g++"
  - name: Python 2.7 on Xenial(clang)
    dist: xenial
    python: '2.7'
    compiler: clang
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
    env:
    - PCL_VERSION="1.7"
    - OS_VERSION="xenial"
    - NOSEATTR="not pcl_ver_0_4 and not pcl_over_18"
    - MATRIX_EVAL="CC=clang && CXX=clang++"
  - name: Python 3.5 on Xenial(clang)
    dist: xenial
    python: '3.5'
    compiler: clang
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - openni2-utils
    env:
    - PCL_VERSION="1.7"
    - OS_VERSION="xenial"
    - NOSEATTR="not pcl_ver_0_4 and not pcl_over_18"
    - MATRIX_EVAL="CC=clang && CXX=clang++"
  - name: Python 3.6 on Xenial(clang)
    dist: xenial
    python: '3.6'
    compiler: clang
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - openni2-utils
    env:
    - PCL_VERSION="1.7"
    - OS_VERSION="xenial"
    - NOSEATTR="not pcl_ver_0_4 and not pcl_over_18"
    - MATRIX_EVAL="CC=clang && CXX=clang++"
  - name: Python 3.7 on Xenial(clang)
    dist: xenial
    python: '3.7'
    compiler: clang
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - openni2-utils
    env:
    - PCL_VERSION="1.7"
    - OS_VERSION="xenial"
    - NOSEATTR="not pcl_ver_0_4 and not pcl_over_18"
    - MATRIX_EVAL="CC=clang && CXX=clang++"
  - name: Python 2.7.16 on macOS using homebrew
    os: osx
    language: generic
    env:
    - PYTHON_VERSION=2.7.16
    - PYENV_ROOT=~/.pyenv
    - PATH=$PYENV_ROOT/shims:$PATH:$PYENV_ROOT/bin
    - NOSEATTR="not pcl_ver_0_4"
  - name: Python 3.5.7 on macOS using homebrew
    os: osx
    language: generic
    env:
    - PYTHON_VERSION=3.5.7
    - PYENV_ROOT=~/.pyenv
    - PATH=$PYENV_ROOT/shims:$PATH:$PYENV_ROOT/bin
    - NOSEATTR="not pcl_ver_0_4"
  - name: Python 3.6.8 on macOS using homebrew
    os: osx
    language: generic
    env:
    - PYTHON_VERSION=3.6.8
    - PYENV_ROOT=~/.pyenv
    - PATH=$PYENV_ROOT/shims:$PATH:$PYENV_ROOT/bin
    - NOSEATTR="not pcl_ver_0_4"
  - name: Python 3.7.3 on macOS using homebrew
    os: osx
    language: generic
    env:
    - PYTHON_VERSION=3.7.3
    - PYENV_ROOT=~/.pyenv
    - PATH=$PYENV_ROOT/shims:$PATH:$PYENV_ROOT/bin
    - NOSEATTR="not pcl_ver_0_4"
cache:
  - pip
  - ccache
#   before_cache:
#     - brew cleanup


before_cache:
  - brew cleanup



before_install:
  - if [ ${TRAVIS_OS_NAME} = "osx" ]; then
      brew update >/dev/null;
      brew install ccache;
    fi

install:
  - pip install --upgrade pip
  - pip install -r requirements.txt
  - pip install wheel
  - pip install twine
  - pip install nose
  # coveralls
  - pip install pytest
  - pip install coveralls
  # codecov
  # - pip install pytest-cov
  # - pip install codecov

  - if [ ${TRAVIS_OS_NAME} = "osx" ]; then
      python setup.py build_ext -i --plat-name macosx-10.9-x86_64;
      python setup.py bdist_wheel --plat-name macosx-10.9-x86_64;
    else
      ${MATRIX_EVAL} python setup.py build_ext -i;
      ${MATRIX_EVAL} python setup.py install;
      ${MATRIX_EVAL} python setup.py bdist_wheel;
    fi

# command to run tests
script:
  # - nosetests --verbose
  # - coverage run --parallel-mode tests/pi_calculator_test.py
  # - coverage run --parallel-mode tests/rect_test.py
  - nosetests --with-coverage --cover-erase --cover-package=template --verbose
  # - py.test --cov pcl
  # examples
  # - python examples/CallTest.py

after_success:
  # coveralls.io
  - coverage combine
  - coveralls
  # codecov.io
  # - codecov

deploy:
  provider: pypi
  user: sirokujira
  password:
    secure: zz1i5hJ9zdXZ+WryKx5PrughDzlJqClAAeEaVgyEQ/almoYkJANWUDW/MbI/Lf39lvhVWwhU7eSai/wPAxasNTSb9L60IFAfqmLDVYzgi2oqBnVrG2la5RDM0ccObwYlmnEjP+08S/R+049kHSEtsu2dszt2Mmko4EUvyzdO5TqYum6pNmB/8XZYRaVVNixva4C76aYDfJ3yfOyJl/pUQoPS3T0u/DWzAJuTgzMS0SRwtEFsno3BK1cRW8cpUThF8/LWGX6Q4C0pReGi4II8bZtlgggrqDZNEszXyGxEbyIvJM7BkxB6uu6AFQtro5ciR3mwSlx5++3KZ6rb9R6nON1HqtrCBiX1TNcBvB7qpYl0hRnAjpDaBmLvK8l74py0sKqb5kpxHUCQ2N24OlVGGf6zC26AuLuJjmq4t9z8A3C9RG+OV0nznY68EsbgHF0pVNbp/TNpfmGG4pXG23exHkFz+kirQGMe4BcQGMIzc1ULpmdu/iaM47BzvsKW18BYT1PY3EkqDWjNR83aFV/YI52L+jzxSkE+GVfkDqARRlP63dE5tfio4+wE84gNgiZwh/zCpBO+Kf4jPDSG2smfHnFQL37COxoLF4R3sUFlY/oUCaXNSuIeLrTtIVk12MzYWZIVm5IxjVUlJIzMJVY7ilexS8MzZgK4lwnpWNFwxyc=
  on:
    # test
    branch: master
    distributions: "sdist bdist_wheel"
    skip_existing: true
